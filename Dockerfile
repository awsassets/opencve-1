FROM python:3.8-slim-buster as base

# Builder
FROM base as builder

RUN apt update && \
    apt full-upgrade -y && \ 
    apt install git libpq-dev -y && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /opencve

RUN git clone https://github.com/opencve/opencve.git .

WORKDIR /app

RUN python3 -m venv /app/venv

ENV PATH="/app/venv/bin:$PATH"

RUN python3 -m pip install --upgrade pip

RUN python3 -m pip install /opencve/

COPY run.sh .

# OpenCVE
FROM base

RUN apt update && \
    apt full-upgrade -y && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/ /app/

WORKDIR /app

ENV PATH="/app/venv/bin:$PATH"

ENV OPENCVE_HOME="/app"

RUN chmod +x ./run.sh

ENTRYPOINT ["./run.sh"]